name: Deploy Supabase

on:
  push:
    branches:
      - main
      - staging
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: false
        type: boolean
      skip_functions:
        description: 'Skip Edge Functions deployment'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_CLI_VERSION: 'latest'

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/staging' && 'staging') || 'dev' }}
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/staging' && 'staging') || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Set project ID in config
        run: |
          # Add project_id to config.toml if not present
          if ! grep -q "^project_id" supabase/config.toml; then
            sed -i '1a project_id = "${{ vars.SUPABASE_PROJECT_ID }}"' supabase/config.toml
          else
            sed -i 's/^project_id = .*/project_id = "${{ vars.SUPABASE_PROJECT_ID }}"/' supabase/config.toml
          fi
          cat supabase/config.toml | head -5

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ vars.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Run database migrations
        if: ${{ github.event.inputs.skip_migrations != 'true' && github.event_name != 'pull_request' }}
        run: |
          echo "Running migrations..."
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy Edge Functions
        if: ${{ github.event.inputs.skip_functions != 'true' && github.event_name != 'pull_request' }}
        run: |
          echo "Deploying Edge Functions..."
          supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Set Edge Function secrets
        if: ${{ github.event.inputs.skip_functions != 'true' && github.event_name != 'pull_request' }}
        run: |
          echo "Setting Edge Function secrets..."

          # Set secrets individually (more reliable than env file)
          supabase secrets set \
            EMAIL_AGENT_LAMBDA_URL="${{ secrets.EMAIL_AGENT_LAMBDA_URL }}" \
            OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
            RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}" \
            RESEND_FROM_EMAIL="${{ secrets.RESEND_FROM_EMAIL }}" \
            RESEND_WEBHOOK_SECRET="${{ secrets.RESEND_WEBHOOK_SECRET }}" \
            EMAIL_USER="${{ secrets.EMAIL_USER }}" \
            EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
            MAILCHIMP_API_KEY="${{ secrets.MAILCHIMP_API_KEY }}" \
            DEFAULT_LLM_MODEL="${{ vars.DEFAULT_LLM_MODEL }}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Validate deployment (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Validating Supabase configuration..."
          # Validate that migrations can be parsed (dry-run)
          supabase db push --dry-run
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/staging' && 'staging') || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project ID**: ${{ vars.SUPABASE_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations**: ${{ github.event.inputs.skip_migrations == 'true' && 'Skipped' || 'Applied' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Functions**: ${{ github.event.inputs.skip_functions == 'true' && 'Skipped' || 'Deployed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
